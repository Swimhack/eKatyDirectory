name: Deploy to Fly.io

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript check
        run: npx tsc --noEmit

      - name: Run linting
        run: npm run lint || true

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run unit tests
        run: npm test -- --passWithNoTests || true
        env:
          DATABASE_URL: "file:./test.db"

  puppeteer-tests:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          sudo wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          sudo apt-get install -y chromium-browser

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: "file:./test.db"
          NEXT_PUBLIC_APP_URL: "http://localhost:3000"
          NEXT_PUBLIC_APP_NAME: "eKaty"

      - name: Start server
        run: |
          npm run start &
          sleep 10
        env:
          DATABASE_URL: "file:./test.db"
          PORT: 3000

      - name: Run Puppeteer tests
        run: npm run test:e2e || true
        env:
          TEST_URL: "http://localhost:3000"

  deploy:
    runs-on: ubuntu-latest
    needs: [test, puppeteer-tests]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Check deployment status
        run: flyctl status
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          response=$(curl -s -o /dev/null -w "%{http_code}" https://ekaty.fly.dev)
          if [ $response -eq 200 ]; then
            echo "‚úÖ Deployment successful - site is responding with 200"
          else
            echo "‚ùå Deployment check failed - site returned $response"
            exit 1
          fi

      - name: Notify on success
        if: success()
        run: echo "üéâ Deployment to Fly.io completed successfully!"

      - name: Notify on failure
        if: failure()
        run: echo "‚ùå Deployment to Fly.io failed. Check logs for details."