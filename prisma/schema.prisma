// This is your Prisma schema file for eKaty
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Using String types for flexibility across database providers
// Valid roles: USER, EDITOR, ADMIN, ADVERTISER
// Valid price levels: BUDGET, MODERATE, UPSCALE, PREMIUM

// Users table
model User {
  id                String              @id @default(cuid())
  email             String              @unique
  name              String?
  passwordHash      String              @map("password_hash")
  role              String              @default("USER")
  stripeCustomerId  String?             @unique @map("stripe_customer_id")
  metadata          String?             // JSON string for magic link tokens, etc.
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")

  // Relations
  reviews           Review[]
  favorites         Favorite[]
  spins             Spin[]
  auditLogs         AuditLog[]
  subscriptions     Subscription[]
  claimRequests     RestaurantClaim[]
  ownedRestaurants  RestaurantOwner[]

  @@map("users")
}

// Restaurants table
model Restaurant {
  id            String      @id @default(cuid())
  name          String
  slug          String      @unique
  description   String?
  address       String
  city          String      @default("Katy")
  state         String      @default("TX")
  zipCode       String      @map("zip_code")
  latitude      Float
  longitude     Float
  phone         String?
  website       String?
  email         String?
  categories    String      // Comma-separated category strings
  cuisineTypes  String      @map("cuisine_types") // Comma-separated cuisine tags
  hours         String      // JSON string with day-of-week hours
  priceLevel    String      @default("MODERATE") @map("price_level")
  photos        String      // Comma-separated photo URLs
  logoUrl       String?     @map("logo_url")
  featured      Boolean     @default(false)
  verified      Boolean     @default(false)
  active        Boolean     @default(true)
  rating        Float?      // Calculated average rating
  reviewCount   Int         @default(0) @map("review_count")
  source        String?     // e.g., "google_places", "manual", "yelp"
  sourceId      String?     @map("source_id") // External API ID
  metadata      String?     // Additional flexible data as JSON string
  adminOverrides String?    @map("admin_overrides") // JSON: locked fields {"phone":true,"hours":true}
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  lastVerified  DateTime?   @map("last_verified")
  
  // Relations
  reviews       Review[]
  favorites     Favorite[]
  spins         Spin[]
  ads           Ad[]
  events        Event[]
  owners        RestaurantOwner[]
  claims        RestaurantClaim[]
  
  @@index([latitude, longitude])
  @@index([featured])
  @@index([categories])
  @@index([active])
  @@index([city])
  @@index([sourceId])
  @@map("restaurants")
}

// Reviews table
model Review {
  id                  String      @id @default(cuid())
  restaurantId        String      @map("restaurant_id")
  userId              String      @map("user_id")
  rating              Int         // 1-5 stars
  title               String?
  text                String
  helpful             Int         @default(0) // Helpful vote count
  photos              String      // Comma-separated review photos
  verified            Boolean     @default(false) // Verified visit
  ownerResponse       String?     @map("owner_response") // Restaurant owner response
  ownerResponseDate   DateTime?   @map("owner_response_date") // When owner responded
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")
  
  // Relations
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([restaurantId, userId])
  @@index([restaurantId])
  @@index([userId])
  @@map("reviews")
}

// Favorites table
model Favorite {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  restaurantId  String      @map("restaurant_id")
  notes         String?     // Personal notes about the favorite
  createdAt     DateTime    @default(now()) @map("created_at")
  
  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@unique([userId, restaurantId])
  @@index([userId])
  @@map("favorites")
}

// Spins table (Grub Roulette history)
model Spin {
  id            String      @id @default(cuid())
  userId        String?     @map("user_id") // Nullable for anonymous spins
  restaurantId  String      @map("restaurant_id")
  spinParams    String      @map("spin_params") // Filters used for spin as JSON string
  seed          String?     // For reproducibility
  sessionId     String?     @map("session_id") // Track anonymous sessions
  createdAt     DateTime    @default(now()) @map("created_at")
  
  // Relations
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
  @@map("spins")
}

// Ads table
model Ad {
  id            String      @id @default(cuid())
  restaurantId  String      @map("restaurant_id")
  title         String
  description   String?
  creative      String      // Ad creative assets and copy as JSON string
  ctaUrl        String      @map("cta_url")
  ctaText       String      @default("Learn More") @map("cta_text")
  startDate     DateTime    @map("start_date")
  endDate       DateTime    @map("end_date")
  budget        Float?      // Optional budget cap
  impressions   Int         @default(0)
  clicks        Int         @default(0)
  active        Boolean     @default(true)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  // Relations
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([startDate, endDate])
  @@index([active])
  @@map("ads")
}

// Events table (restaurant promotions, special events)
model Event {
  id            String      @id @default(cuid())
  restaurantId  String      @map("restaurant_id")
  title         String
  description   String
  imageUrl      String?     @map("image_url")
  startDate     DateTime    @map("start_date")
  endDate       DateTime    @map("end_date")
  active        Boolean     @default(true)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  // Relations
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  @@index([restaurantId])
  @@index([startDate, endDate])
  @@index([active])
  @@map("events")
}

// Audit logs table
model AuditLog {
  id            String      @id @default(cuid())
  entity        String      // Table/model name
  entityId      String      @map("entity_id")
  action        String      // CREATE, UPDATE, DELETE
  userId        String?     @map("user_id")
  changes       String?     // Before/after values as JSON string
  metadata      String?     // Additional context as JSON string
  ipAddress     String?     @map("ip_address")
  userAgent     String?     @map("user_agent")
  createdAt     DateTime    @default(now()) @map("created_at")
  
  // Relations
  user          User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Contact form submissions (for tracking)
model ContactSubmission {
  id            String      @id @default(cuid())
  name          String
  email         String
  phone         String?
  subject       String
  message       String
  type          String      // "general", "advertising", "support", "partnership"
  metadata      String?     // Additional form data as JSON string
  responded     Boolean     @default(false)
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([type])
  @@index([responded])
  @@map("contact_submissions")
}

// API usage tracking (for rate limiting)
model ApiUsage {
  id            String      @id @default(cuid())
  date          String      @unique // YYYY-MM-DD format
  requestCount  Int         @default(0) @map("request_count")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@map("api_usage")
}

// Subscriptions table (Stripe subscriptions)
model Subscription {
  id                    String      @id @default(cuid())
  userId                String      @map("user_id")
  stripeSubscriptionId  String      @unique @map("stripe_subscription_id")
  stripePriceId         String      @map("stripe_price_id")
  stripeProductId       String      @map("stripe_product_id")
  status                String      // active, canceled, past_due, etc.
  tier                  String      // owner, featured, premium
  currentPeriodStart    DateTime    @map("current_period_start")
  currentPeriodEnd      DateTime    @map("current_period_end")
  cancelAtPeriodEnd     Boolean     @default(false) @map("cancel_at_period_end")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  // Relations
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

// Restaurant ownership (links users to restaurants they own)
model RestaurantOwner {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  restaurantId  String      @map("restaurant_id")
  role          String      @default("owner") // owner, manager, staff
  verified      Boolean     @default(false)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
  @@index([userId])
  @@index([restaurantId])
  @@map("restaurant_owners")
}

// Restaurant claim requests
model RestaurantClaim {
  id                    String      @id @default(cuid())
  userId                String      @map("user_id")
  restaurantId          String      @map("restaurant_id")
  status                String      @default("pending") // pending, approved, rejected
  verificationMethod    String?     @map("verification_method") // email_domain, phone, stripe_identity, manual
  verificationData      String?     @map("verification_data") // JSON with verification details
  adminNotes            String?     @map("admin_notes")
  reviewedBy            String?     @map("reviewed_by") // Admin user ID
  reviewedAt            DateTime?   @map("reviewed_at")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  // Relations
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant            Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([restaurantId])
  @@index([status])
  @@map("restaurant_claims")
}

// Blog articles table
model BlogArticle {
  id              String      @id @default(cuid())
  title           String
  slug            String      @unique
  content         String      // HTML content
  metaDescription String?     @map("meta_description")
  keywords        String?     // Comma-separated keywords
  authorName      String      @default("James Strickland") @map("author_name")
  contactEmail    String?     @map("contact_email")
  phoneNumber     String?     @map("phone_number")
  publishedDate   DateTime?   @map("published_date")
  status          String      @default("published") // draft, published
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([status])
  @@index([publishedDate])
  @@index([slug])
  @@map("blog_articles")
}

// Community suggestions table
model Suggestion {
  id                String      @id @default(cuid())
  type              String      // correction, new_restaurant, photo, review, translation, menu, hours
  restaurantId      String?     @map("restaurant_id")
  restaurantName    String?     @map("restaurant_name") // For new restaurant suggestions
  field             String?     // Which field to update (phone, hours, address, etc)
  currentValue      String?     @map("current_value") // Current value in database
  suggestedValue    String      @map("suggested_value") // Suggested new value
  reason            String?     // Why the change is needed
  submittedBy       String?     @map("submitted_by") // Email (optional)
  submitterName     String?     @map("submitter_name") // Name (optional)
  status            String      @default("pending") // pending, approved, rejected, duplicate
  priority          String      @default("normal") // low, normal, high, urgent
  confidence        Float?      // AI confidence score 0-1
  votes             Int         @default(0) // Community upvotes
  adminNotes        String?     @map("admin_notes")
  reviewedBy        String?     @map("reviewed_by") // Admin user ID
  reviewedAt        DateTime?   @map("reviewed_at")
  appliedAt         DateTime?   @map("applied_at") // When change was applied
  metadata          String?     // Additional data as JSON (photos, coordinates, etc)
  ipAddress         String?     @map("ip_address") // For spam prevention
  userAgent         String?     @map("user_agent")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@index([type])
  @@index([status])
  @@index([restaurantId])
  @@index([priority])
  @@index([createdAt])
  @@index([submittedBy])
  @@map("suggestions")
}

// Launch Giveaway Entries ($500 gift card giveaway)
model LaunchGiveawayEntry {
  id            String      @id @default(cuid())
  email         String
  name          String
  phone         String?
  source        String      @default("website") // website, social, flyer
  referralCode  String?     @map("referral_code") // Track referrals
  metadata      String?     // JSON: social shares, engagement data
  ipAddress     String?     @map("ip_address") // Prevent duplicates
  winner        Boolean     @default(false) // Mark the winner(s)
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([email])
  @@index([winner])
  @@index([createdAt])
  @@map("launch_giveaway_entries")
}

// Launch Coupons (20% off at participating restaurants)
model LaunchCoupon {
  id                String      @id @default(cuid())
  code              String      @unique // Unique coupon code
  restaurantId      String?     @map("restaurant_id") // Null = valid at all participating
  restaurantName    String?     @map("restaurant_name") // Denormalized for quick display
  discountPercent   Int         @default(20) @map("discount_percent")
  maxDiscount       Float?      @map("max_discount") // Cap in dollars
  minPurchase       Float?      @map("min_purchase") // Minimum purchase required
  validFrom         DateTime    @map("valid_from")
  validUntil        DateTime    @map("valid_until")
  maxRedemptions    Int         @default(100) @map("max_redemptions") // Total redemption limit
  redemptionCount   Int         @default(0) @map("redemption_count")
  perUserLimit      Int         @default(1) @map("per_user_limit") // Redemptions per user
  active            Boolean     @default(true)
  termsAndConditions String?    @map("terms_and_conditions")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  redemptions       CouponRedemption[]

  @@index([code])
  @@index([restaurantId])
  @@index([active])
  @@index([validFrom, validUntil])
  @@map("launch_coupons")
}

// Coupon Redemptions (track who redeemed what)
model CouponRedemption {
  id            String      @id @default(cuid())
  couponId      String      @map("coupon_id")
  email         String      // User who redeemed
  name          String?
  phone         String?
  restaurantId  String?     @map("restaurant_id") // Where it was redeemed
  orderValue    Float?      @map("order_value") // Total order amount
  discountAmount Float?     @map("discount_amount") // Actual discount applied
  redemptionDate DateTime   @default(now()) @map("redemption_date")
  metadata      String?     // JSON: additional redemption details
  verified      Boolean     @default(false) // Restaurant confirmed redemption

  // Relations
  coupon        LaunchCoupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([email])
  @@index([restaurantId])
  @@index([redemptionDate])
  @@map("coupon_redemptions")
}

// Flyer Downloads (track promotional material downloads)
model FlyerDownload {
  id            String      @id @default(cuid())
  flyerType     String      @map("flyer_type") // social_media, printable, business_card, poster
  format        String      // pdf, png, jpg
  email         String?     // Optional: who downloaded
  name          String?
  downloadUrl   String      @map("download_url") // S3 or R2 URL
  shareCount    Int         @default(0) @map("share_count") // Track social shares
  ipAddress     String?     @map("ip_address")
  userAgent     String?     @map("user_agent")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([flyerType])
  @@index([email])
  @@index([createdAt])
  @@map("flyer_downloads")
}

// Early Adopter Achievements (reward first users)
model EarlyAdopterAchievement {
  id                String      @id @default(cuid())
  email             String      // User email (before they might have full account)
  achievementType   String      @map("achievement_type") // first_100, first_500, first_spin, first_review, etc.
  badgeName         String      @map("badge_name") // Display name
  badgeIcon         String      @map("badge_icon") // Emoji or icon
  earnedAt          DateTime    @default(now()) @map("earned_at")
  rewardDescription String?     @map("reward_description") // What they unlocked
  metadata          String?     // JSON: additional achievement data

  @@index([email])
  @@index([achievementType])
  @@index([earnedAt])
  @@map("early_adopter_achievements")
}

// Launch Metrics Dashboard (aggregate stats)
model LaunchMetric {
  id                String      @id @default(cuid())
  date              String      @unique // YYYY-MM-DD
  giveawayEntries   Int         @default(0) @map("giveaway_entries")
  couponsGenerated  Int         @default(0) @map("coupons_generated")
  couponsRedeemed   Int         @default(0) @map("coupons_redeemed")
  flyersDownloaded  Int         @default(0) @map("flyers_downloaded")
  newUsers          Int         @default(0) @map("new_users")
  restaurantSpins   Int         @default(0) @map("restaurant_spins")
  socialShares      Int         @default(0) @map("social_shares")
  pageViews         Int         @default(0) @map("page_views")
  metadata          String?     // JSON: additional daily metrics
  updatedAt         DateTime    @updatedAt @map("updated_at")

  @@index([date])
  @@map("launch_metrics")
}